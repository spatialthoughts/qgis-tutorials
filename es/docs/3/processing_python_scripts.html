<!DOCTYPE html>

<html lang="es" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Escribir Scripts Python para el Marco de Procesamiento (QGIS3) &#8212; QGIS Tutorials and Tips</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=0bf093e7" />
    <script src="../../_static/documentation_options.js?v=92345faf"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=efdbd0b9"></script>
    <link rel="search" title="Búsqueda" href="../../search.html" />
    <link rel="next" title="Construyendo un Complemento Python (QGIS3)" href="building_a_python_plugin.html" />
    <link rel="prev" title="Usando Funciones de Expresión Python Personalizadas (QGIS3)" href="custom_python_functions.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>


<!-- Cookie Notice -->
<!-- Script from https://github.com/AOEpeople/cookie-notice -->
<script type="text/javascript" src="../../_static/cookie.notice.min.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B1WQ7B80XJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B1WQ7B80XJ');
</script>


  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          QGIS Tutorials and Tips</a>
        <span class="navbar-text navbar-version pull-left"><b>v1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Tutorials List <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introducción</a></li>
<li class="toctree-l1"><a class="reference internal" href="making_a_map.html">Haciendo un Mapa (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_attributes.html">Trabajando con atributos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing_spreadsheets_csv.html">Importar Hojas de Cálculo o archivos CSV (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_vector_styling.html">Estilo Básico Vectorial (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculating_line_lengths.html">Calcular Longitudes y Estadísticas de Línea (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="raster_styling_and_analysis.html">Estilos y Análisis Básicos Ráster (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="raster_mosaicing_and_clipping.html">Mosaicar y Recortar Ráster (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_terrain.html">Trabajar con Datos de Terreno (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_wms.html">Trabajar con Datos WMS (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_projections.html">Trabajar con Proyecciones (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="georeferencing_basics.html">Georeferenciar Hojas Topográficas y Mapas Escaneados (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_georeferencing.html">Georeferenciar Imágenes Aéreas (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="digitizing_basics.html">Digitalizar Datos del Mapa (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_table_joins.html">Realizar Uniones de Tablas (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_spatial_joins.html">Realizar Uniones Espaciales (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_spatial_queries.html">Realizar Consultas Espaciales (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="nearest_neighbor_analysis.html">Análisis del Vecino Más Cercano (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampling_raster_data.html">Muestrear Datos Ráster usando Puntos o Polígonos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculating_raster_area.html">Cálcular el área ráster (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="creating_heatmaps.html">Crear Mapas de Calor (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="animating_time_series.html">Animar Datos de Series de Tiempo (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="handling_invalid_geometries.html">Manejar Geometrías No Válidas (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_raster_analysis.html">Análisis Avanzado de Ráster (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="interpolating_point_data.html">Interpolar Datos Punto (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_processing.html">Procesamiento por Lotes usando el Marco de Procesamiento (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_graphical_modeler.html">Automatizar Flujos de Trabajo Complejos usando el Modelador de Procesos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="automating_map_creation.html">Automatización de la creación de mapas con el Atlas de diseñador de impresiones  (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_criteria_overlay.html">Análisis de Sobreposición Multicriterio (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="vector_styling_expressions.html">Filtrado básico y estilización con expresiones (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="block_world_styling.html">Creación de un Mapa Mundial de Bloques (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="river_styling_expressions.html">Estilización de una red fluvial con expresiones (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="contour_3d_styling.html">Styling Contours in 3D (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="isometric_buildings.html">Creación de edificios isométricos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactive_canvas_maps.html">Creación de mapas interactivos en lienzo (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactive_reveal_maps.html">Creación de mapas interactivos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cartogram_animation.html">Creación de un cartograma animado (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_network_analysis.html">Visualización y Enrutamiento Básico de Red (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="origin_destination_matrix.html">Localizando la Instalación Más Cercana con Matriz Origen-Destino (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="service_area_analysis.html">Análisis de Área de Servicio usando Openrouteservice (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="travel_time_analysis.html">Análisis del tiempo de viaje con el movimiento de Uber (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="areal_mean_rainfall.html">Calcular la Precipitación Media de Área (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="colorized_river_basin_map.html">Creación de un mapa de cuenca fluvial coloreado (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="creating_landuse_map.html">Creación de un mapa de uso de la tierra (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculating_intersection_density.html">Calcular Densidad de Intersección de Calle (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="landuse_buffer.html">Determinación de zonas de influencia de usos de la tierra (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="solidwaste_mapping.html">Cartografía de los volúmenes de eliminación de residuos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_with_pyqgis.html">Iniciándote con la Programación Python (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_algorithms_pyqgis.html">Ejecutar Algoritmos de Procesamiento vía Python (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_python_functions.html">Usando Funciones de Expresión Python Personalizadas (QGIS3)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Escribir Scripts Python para el Marco de Procesamiento (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_a_python_plugin.html">Construyendo un Complemento Python (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_python_plugin.html">Construyendo un Complemento de Procesamiento (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_qgis_jobs.html">Ejecutar y Programar Trabajos de Procesamiento QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="web_mapping_with_qgis2web.html">Mapeo Web con QGIS2Web (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../creating_basemaps_with_qtiles.html">Creando Mapas Base con QTiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_plugins.html">Usar Complementos (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../downloading_osm_data.html">Buscando y descargando datos de OpenStreetMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../learning_resources.html">Recursos de Aprendizaje QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Créditos de los Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../batch_processing.html">Procesamiento por Lotes usando el Marco de Procesamiento (QGIS2)</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="custom_python_functions.html" title="Previous Chapter: Usando Funciones de Expresión Python Personalizadas (QGIS3)"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Usando Funcio...</span>
    </a>
  </li>
  <li>
    <a href="building_a_python_plugin.html" title="Next Chapter: Construyendo un Complemento Python (QGIS3)"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Construyendo ... &raquo;</span>
    </a>
  </li>
              
            
            

            

            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><h4>Author</h4>
<p><a href="https://www.linkedin.com/in/spatialthoughts/"><img src="../../_static/ujaval.png">Ujaval Gandhi</a></p>

<hr>
<p>Want to learn QGIS in a structured way? Check out <a href="https://spatialthoughts.com/" target="_blank">Spatial Thoughts</a> for more learning materials and instructor-led online programs with QGIS.org certification.</p>

<hr>
<p>These tutorials are also available in many other languages. Please see <a href="https://www.qgistutorials.com/en/docs/introduction.html#translations" target="_blank">translations</a> page.
</p>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      

  <section id="writing-python-scripts-for-processing-framework-qgis3">
<h1>Escribir Scripts Python para el Marco de Procesamiento (QGIS3)<a class="headerlink" href="#writing-python-scripts-for-processing-framework-qgis3" title="Link to this heading">¶</a></h1>
<p>Uno puede escribir scripts pyqgis autónomos que pueden ser ejecutados mediante la Consola de Python en QGIS. Con unos pocos ajustes, puede hacer que sus scripts autónomos se ejecuten mediante el Marco de Procesamiento. Esto tiene varias ventajas. Primero, es mucho más fácil tomar entradas del usuario y escribir archivos de salida debido a que el Marco de Procesamiento ofrece un interfaz de usuario estandarizado para estos. Segundo, el tener su script en la Caja de Herramientas de Procesamiento también le permite que sea parte de cualquier Modelo de Procesamiento o que sea ejecutado como un Trabajo por Lotes con múltiples entradas. Este tutorial mostrará cómo escribir un script python personalizado que puede ser parte del Marco de Procesamiento en QGIS.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La API Procesamiento fue completamente revisada en QGIS3. Por favor refiérase a <a class="reference external" href="https://raw.githubusercontent.com/qgis/QGIS/master/doc/porting_processing.dox">esta guía</a> para las mejores prácticas y consejos.</p>
</div>
<section id="overview-of-the-task">
<h2>Vista general de la tarea<a class="headerlink" href="#overview-of-the-task" title="Link to this heading">¶</a></h2>
<p>Nuestro script realizará una operación de disolución basada en un campo escogido por el usuario. También sumará valores de otro campo para las entidades disueltas. En el ejemplo, disolveremos un archivo shape del mundo basado en un atributo <code class="docutils literal notranslate"><span class="pre">CONTINENT</span></code> y sumaremos el campo <code class="docutils literal notranslate"><span class="pre">POP_EST</span></code> para calcular la población total en la región disuelta.</p>
</section>
<section id="get-the-data">
<h2>Obtener los datos<a class="headerlink" href="#get-the-data" title="Link to this heading">¶</a></h2>
<p>Utilizaremos el conjunto de datos <a class="reference external" href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/10m-admin-0-countries/">Admin 0 - Países</a> de Natural Earth.</p>
<p>Descargue el archivo shape <a class="reference external" href="https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_0_countries.zip">Admin 0 - países.</a>.</p>
<p>Fuente de Datos <a class="reference internal" href="../credits.html#naturalearth" id="id1"><span>[NATURALEARTH]</span></a></p>
<p>Para su comodidad, puede descargar directamente un geopackage que contiene las capas de arriba de aquí abajo:</p>
<p><a class="reference external" href="https://www.qgistutorials.com/downloads/ne_global.gpkg">ne_global.gpkg</a></p>
</section>
<section id="procedure">
<h2>Procedimiento<a class="headerlink" href="#procedure" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>En el Panel Navegador QGIS, localice el directorio donde guardó sus datos descargados. Expanda el <code class="docutils literal notranslate"><span class="pre">zip</span></code> o la entrada <code class="docutils literal notranslate"><span class="pre">gpkg</span></code> y seleccione la capa <code class="docutils literal notranslate"><span class="pre">ne_10m_admin_0_countries</span></code>. Arrastre la capa a la pantalla.</p></li>
</ol>
<img alt="../../_images/1146.png" class="align-center" src="../../_images/1146.png" />
<ol class="arabic simple" start="2">
<li><p>Vaya a <span class="menuselection">Procesos ‣ Caja de Herramientas</span>. Clic en el botón <span class="guilabel">Scripts</span> en la barra de herramientas y seleccione <span class="guilabel">Crear Nuevo Script de Plantilla</span>.</p></li>
</ol>
<img alt="../../_images/2125.png" class="align-center" src="../../_images/2125.png" />
<ol class="arabic simple" start="3">
<li><p>La plantilla contiene todo el código repetitivo que es requerido para que el Marco Procesamiento lo reconozca como un script Procesamiento, y gestione entradas/salidas. Comencemos personalizando la plantilla ejemplo a nuestras necesidades. Primero cambie el nombre de clase de <code class="docutils literal notranslate"><span class="pre">ExampleProcessingAlgorithm</span></code> a <code class="docutils literal notranslate"><span class="pre">DissolveProcessingAlgorithm</span></code>. Este nombre también necesita ser actualizado en el método <code class="docutils literal notranslate"><span class="pre">createInstance</span></code>. Agregue una dosctring a la clase que explica lo que hace el algoritmo.</p></li>
</ol>
<img alt="../../_images/360.png" class="align-center" src="../../_images/360.png" />
<ol class="arabic simple" start="4">
<li><p>A medida que se desliza hacia abajo, verá métodos que asignan nombre, grupo, descripción, etc. al script. cambie los valores de retorno para el método <em>name</em> para que sea <code class="docutils literal notranslate"><span class="pre">dissolve_with_sum</span></code>, el método <em>displayName</em> a <code class="docutils literal notranslate"><span class="pre">Dissolve</span> <span class="pre">with</span> <span class="pre">Sum</span></code>, el método <em>group</em> y el método <em>groupId</em> a <code class="docutils literal notranslate"><span class="pre">scripts</span></code>. Cambie el valor de retorno del método <em>shortHelpString</em> a una descripción que aparecerá al usuario. Clic en el botón <span class="guilabel">Guardar</span>.</p></li>
</ol>
<img alt="../../_images/434.png" class="align-center" src="../../_images/434.png" />
<ol class="arabic simple" start="5">
<li><p>Nombre el script como <code class="docutils literal notranslate"><span class="pre">dissolve_with_sum</span></code> y guárdelo en la ubicación predeterminada bajo la carpeta <span class="menuselection">perfiles ‣ predeterminado ‣ procesos ‣ scripts</span>.</p></li>
</ol>
<img alt="../../_images/530.png" class="align-center" src="../../_images/530.png" />
<ol class="arabic simple" start="6">
<li><p>Ahora definiremos las entradas para el script. La plantilla ya contiene una definición de un Capa Vector <code class="docutils literal notranslate"><span class="pre">INPUT</span></code> y una capa <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>. Agregaremos 2 nuevas entradas que permiten al usuario seleccionar un <code class="docutils literal notranslate"><span class="pre">DISSOLVE_FIELD</span></code> y un <code class="docutils literal notranslate"><span class="pre">SUM_FIELD</span></code>. Agregue un nueva importación arriba y el siguiente código en el método <code class="docutils literal notranslate"><span class="pre">initAlgorithm</span></code>. Clic en el botón <span class="guilabel">Ejecutar</span> para previsualizar los cambios.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsProcessingParameterField</span>

<span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
        <span class="n">QgsProcessingParameterField</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DISSOLVE_FIELD</span><span class="p">,</span>
                <span class="s1">&#39;Choose Dissolve Field&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">))</span>

<span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
        <span class="n">QgsProcessingParameterField</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SUM_FIELD</span><span class="p">,</span>
                <span class="s1">&#39;Choose Sum Field&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../../_images/6a.png" class="align-center" src="../../_images/6a.png" />
<img alt="../../_images/6b.png" class="align-center" src="../../_images/6b.png" />
<ol class="arabic simple" start="7">
<li><p>Verá un diálogo <span class="guilabel">Disolver con Suma</span> con nuestras entradas recientemente definidas. Seleccione la capa <code class="docutils literal notranslate"><span class="pre">ne_10m_admin_0_countries</span></code> como la <span class="guilabel">Capa de entrada`</span>. Como tanto <span class="guilabel">Campo disolución</span> como <span class="guilabel">Campos Suma</span> son filtrados en base a la capa de entrada, ellos serán pre-poblados con campos existentes de la capa de entrada. Clic en el botón <span class="guilabel">Cerrar</span>.</p></li>
</ol>
<img alt="../../_images/729.png" class="align-center" src="../../_images/729.png" />
<ol class="arabic simple" start="8">
<li><p>Ahora definiremos nuestra lógica personalizada para procesar datos en el método <code class="docutils literal notranslate"><span class="pre">processAlgorithm</span></code>. A este método se le pasa un diccionario lamado <code class="docutils literal notranslate"><span class="pre">parameters</span></code>. Contiene las entradas que el usuario tiene seleccionadas. Hay métodos que ayudan que le permiten tomar estas entradas y crear objetos apropiados. Primero conseguimos nuestras entradas usando los métodos <code class="docutils literal notranslate"><span class="pre">parameterAsSource</span></code> y <code class="docutils literal notranslate"><span class="pre">parameterAsString</span></code>. A continuación, queremos crear un sumidero de entidades donde escribiremos la salida. QGIS3 tiene una nueva clase llamada <code class="docutils literal notranslate"><span class="pre">QgsFeatureSink</span></code> que es la manera preferida para crear objetos que puedan aceptar nuevas entidades. La salida necesita sólo 2 campos - uno para el valor del campo disuelto y otro para la suma del campo seleccionado.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QVariant</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsField</span><span class="p">,</span> <span class="n">QgsFields</span>

<span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsSource</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span>
        <span class="n">context</span><span class="p">)</span>
<span class="n">dissolve_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsString</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DISSOLVE_FIELD</span><span class="p">,</span>
        <span class="n">context</span><span class="p">)</span>
<span class="n">sum_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsString</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SUM_FIELD</span><span class="p">,</span>
        <span class="n">context</span><span class="p">)</span>

<span class="n">fields</span> <span class="o">=</span> <span class="n">QgsFields</span><span class="p">()</span>
<span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="n">dissolve_field</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">))</span>
<span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s1">&#39;SUM_&#39;</span> <span class="o">+</span> <span class="n">sum_field</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">Double</span><span class="p">))</span>

<span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsSink</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">,</span>
        <span class="n">context</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">wkbType</span><span class="p">(),</span> <span class="n">source</span><span class="o">.</span><span class="n">sourceCrs</span><span class="p">())</span>
</pre></div>
</div>
<img alt="../../_images/8a.png" class="align-center" src="../../_images/8a.png" />
<img alt="../../_images/8b.png" class="align-center" src="../../_images/8b.png" />
<ol class="arabic simple" start="9">
<li><p>Ahora alistaremos los objetos de entrada y crearemos un diccionario para retener los valores únicos del dissolve_field y la suma de los valores del sum_field. Note el uso del método <code class="docutils literal notranslate"><span class="pre">feedback.pushInfo()</span></code> para comunicar el estado con el usuario.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feedback</span><span class="o">.</span><span class="n">pushInfo</span><span class="p">(</span><span class="s1">&#39;Extracting unique values from dissolve_field and computing sum&#39;</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()</span>
<span class="n">unique_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">)</span>

<span class="c1"># Get Indices of dissolve field and sum field</span>
<span class="n">dissolveIdx</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">fields</span><span class="p">()</span><span class="o">.</span><span class="n">indexFromName</span><span class="p">(</span><span class="n">dissolve_field</span><span class="p">)</span>
<span class="n">sumIdx</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">fields</span><span class="p">()</span><span class="o">.</span><span class="n">indexFromName</span><span class="p">(</span><span class="n">sum_field</span><span class="p">)</span>

<span class="c1"># Find all unique values for the given dissolve_field and</span>
<span class="c1"># sum the corresponding values from the sum_field</span>
<span class="n">sum_unique_values</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">attrs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">dissolve_field</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="n">dissolveIdx</span><span class="p">],</span> <span class="n">sum_field</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="n">sumIdx</span><span class="p">]}</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()]</span>
<span class="k">for</span> <span class="n">unique_value</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f_attr</span><span class="p">[</span><span class="n">sum_field</span><span class="p">]</span> <span class="k">for</span> <span class="n">f_attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">f_attr</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]</span> <span class="o">==</span> <span class="n">unique_value</span><span class="p">]</span>
        <span class="n">sum_unique_values</span><span class="p">[</span><span class="n">unique_value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">val_list</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/929.png" class="align-center" src="../../_images/929.png" />
<ol class="arabic simple" start="10">
<li><p>A continuación, llamaremos el algoritmo incorporado de procesamiento <code class="docutils literal notranslate"><span class="pre">native:dissolve</span></code> sobre la capa de entrada para generar las geometrías disueltas. Una vez que tengamos las geometrías disueltas, iteraremos a través de la salida del algoritmo de disolución y crearemos nuevos objetos para ser agregados a la salida. Al final regresaremos el <code class="docutils literal notranslate"><span class="pre">dest_id</span></code> FeatureSink como la salida. Ahora el script está listo. Clic en el botón <span class="guilabel">Ejecutar</span>.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Note el uso de <code class="docutils literal notranslate"><span class="pre">parameters[self.INPUT]</span></code> para ir a buscar la capa de entrada del diccionario de parámetros directamente sin definirlo como una fuente. Como estamos pasando el objeto de entrada al algoritmo sin hacer nada con él, no es necesario definirlo como una fuente.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsFeature</span>

<span class="c1"># Running the processing dissolve algorithm</span>
<span class="n">feedback</span><span class="o">.</span><span class="n">pushInfo</span><span class="p">(</span><span class="s1">&#39;Dissolving features&#39;</span><span class="p">)</span>
<span class="n">dissolved_layer</span> <span class="o">=</span> <span class="n">processing</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;native:dissolve&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;INPUT&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">],</span>
        <span class="s1">&#39;FIELD&#39;</span><span class="p">:</span> <span class="n">dissolve_field</span><span class="p">,</span>
        <span class="s1">&#39;OUTPUT&#39;</span><span class="p">:</span> <span class="s1">&#39;memory:&#39;</span>
        <span class="p">},</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">feedback</span><span class="o">=</span><span class="n">feedback</span><span class="p">)[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span>

<span class="c1"># Read the dissolved layer and create output features</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dissolved_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">():</span>
        <span class="n">new_feature</span> <span class="o">=</span>  <span class="n">QgsFeature</span><span class="p">()</span>
        <span class="c1"># Set geometry to dissolved geometry</span>
        <span class="n">new_feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
        <span class="c1"># Set attributes from sum_unique_values dictionary that we had computed</span>
        <span class="n">new_feature</span><span class="o">.</span><span class="n">setAttributes</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">],</span> <span class="n">sum_unique_values</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]]])</span>
        <span class="n">sink</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">new_feature</span><span class="p">,</span> <span class="n">QgsFeatureSink</span><span class="o">.</span><span class="n">FastInsert</span><span class="p">)</span>

<span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">:</span> <span class="n">dest_id</span><span class="p">}</span>
</pre></div>
</div>
<img alt="../../_images/10a.png" class="align-center" src="../../_images/10a.png" />
<img alt="../../_images/10b.png" class="align-center" src="../../_images/10b.png" />
<ol class="arabic simple" start="11">
<li><p>En el diálogo <span class="guilabel">Disolver con Suma</span>, seleccione <code class="docutils literal notranslate"><span class="pre">ne_10m_admin_0_countries</span></code> como la <span class="guilabel">Capa de entrada</span>, <code class="docutils literal notranslate"><span class="pre">CONTINENT</span></code> como el <span class="guilabel">Campo de disolución</span> y <code class="docutils literal notranslate"><span class="pre">POP_EST</span></code> como el <span class="guilabel">Campo de suma</span>. Clic en <span class="guilabel">Ejecutar</span>.</p></li>
</ol>
<img alt="../../_images/1147.png" class="align-center" src="../../_images/1147.png" />
<ol class="arabic simple" start="12">
<li><p>Una vez finalice el procesamiento, haga clic en el botón <span class="guilabel">Cerrar</span> y cámbiese a la ventana principal de QGIS.</p></li>
</ol>
<img alt="../../_images/1238.png" class="align-center" src="../../_images/1238.png" />
<ol class="arabic simple" start="13">
<li><p>Verá la capa de salida disuelta con un objeto espacial por cada continente y la población total agregada de los países individuales que pertenecen a ese continente.</p></li>
</ol>
<img alt="../../_images/1336.png" class="align-center" src="../../_images/1336.png" />
<ol class="arabic simple" start="14">
<li><p>Otra ventaja de escribir scripts de procesamiento es que los métodos dentro del Marco de Procesamiento identifican la sección de capa y automáticamente filtran sus entrada para usar sólo los objetos seleccionados. Esto sucede porque estamos definiendo nuestra entrada como una <code class="docutils literal notranslate"><span class="pre">QgsProcessingParameterFeatureSource</span></code>. Una fuente de objeto permite usar CUALQUIER objeto que contiene objetos vector, no sólo una capa vector, por lo que cuando hay objetos seleccionados en su capa y se pide a Procesamiento usar objetos seleccionados, la entrada es pasada a su script como un objeto <code class="docutils literal notranslate"><span class="pre">QgsProcessingFeatureSource</span></code> que contiene los objetos seleccionados y no la capa vector completa. Aquí tiene una demostración rápida de esta funcionalidad. Digamos que queremos disolver sólo ciertos continentes. Creemos una selección usando la herramienta <span class="guilabel">Seleccionar objeto por Expresión</span>.</p></li>
</ol>
<img alt="../../_images/1433.png" class="align-center" src="../../_images/1433.png" />
<ol class="arabic simple" start="15">
<li><p>Ingrese la siguiente expresión para seleccionar objetos de Norte y Sud América y clic en <span class="guilabel">Seleccionar</span>.</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;CONTINENT&quot; = &#39;North America&#39; OR &quot;CONTINENT&quot; = &#39;South America&#39;
</pre></div>
</div>
<img alt="../../_images/1529.png" class="align-center" src="../../_images/1529.png" />
<ol class="arabic simple" start="16">
<li><p>Verá que los objetos seleccionados son resaltados en amarillo. Localice el script <code class="docutils literal notranslate"><span class="pre">dissolve_with_sum</span></code> y haga doble-clic para ejecutarlo.</p></li>
</ol>
<img alt="../../_images/1628.png" class="align-center" src="../../_images/1628.png" />
<ol class="arabic simple" start="17">
<li><p>En el diálogo <span class="guilabel">Disolver con Suma</span>, seleccione <code class="docutils literal notranslate"><span class="pre">ne_10m_admin_0_countries</span></code> como la <span class="guilabel">Capa de entrada</span>. Esta vez, asegúrese que marca la casilla <span class="guilabel">Sólo objetos seleccionados</span>. Elija <code class="docutils literal notranslate"><span class="pre">SUBREGIÓN</span></code> como el <span class="guilabel">Campo disolver</span> y <code class="docutils literal notranslate"><span class="pre">POP_EST</span></code> como el <span class="guilabel">Campo suma</span>.</p></li>
</ol>
<img alt="../../_images/1729.png" class="align-center" src="../../_images/1729.png" />
<ol class="arabic simple" start="18">
<li><p>Una vez que termine el proceso, clic en <span class="guilabel">Cerrar</span> y vuelva a la ventana principal QGIS. Notará una nueva capa con sólo los objetos seleccionados disueltos. Clic en el botón <span class="guilabel">Identificar</span> y clic en un objeto para inspeccionar y verificar que el script funcionó correctamente.</p></li>
</ol>
<img alt="../../_images/1825.png" class="align-center" src="../../_images/1825.png" />
<p>Abajo está el script completo para referencia. Puede modificarlo para ajustarlo a sus necesidades.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">***************************************************************************</span>
<span class="sd">*                                                                         *</span>
<span class="sd">*   This program is free software; you can redistribute it and/or modify  *</span>
<span class="sd">*   it under the terms of the GNU General Public License as published by  *</span>
<span class="sd">*   the Free Software Foundation; either version 2 of the License, or     *</span>
<span class="sd">*   (at your option) any later version.                                   *</span>
<span class="sd">*                                                                         *</span>
<span class="sd">***************************************************************************</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QCoreApplication</span><span class="p">,</span> <span class="n">QVariant</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="p">(</span><span class="n">QgsProcessing</span><span class="p">,</span>
                       <span class="n">QgsFeatureSink</span><span class="p">,</span>
                       <span class="n">QgsFeature</span><span class="p">,</span>
                       <span class="n">QgsField</span><span class="p">,</span>
                       <span class="n">QgsFields</span><span class="p">,</span>
                       <span class="n">QgsProcessingException</span><span class="p">,</span>
                       <span class="n">QgsProcessingAlgorithm</span><span class="p">,</span>
                       <span class="n">QgsProcessingParameterFeatureSource</span><span class="p">,</span>
                       <span class="n">QgsProcessingParameterFeatureSink</span><span class="p">,</span>
                       <span class="n">QgsProcessingParameterField</span><span class="p">,</span>
                       <span class="p">)</span>
<span class="kn">import</span> <span class="nn">processing</span>


<span class="k">class</span> <span class="nc">DissolveProcessingAlgorithm</span><span class="p">(</span><span class="n">QgsProcessingAlgorithm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dissolve algorithm that dissolves features based on selected</span>
<span class="sd">    attribute and summarizes the selected field by cumputing the</span>
<span class="sd">    sum of dissolved features.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">INPUT</span> <span class="o">=</span> <span class="s1">&#39;INPUT&#39;</span>
    <span class="n">OUTPUT</span> <span class="o">=</span> <span class="s1">&#39;OUTPUT&#39;</span>
    <span class="n">DISSOLVE_FIELD</span> <span class="o">=</span> <span class="s1">&#39;dissolve_field&#39;</span>
    <span class="n">SUM_FIELD</span> <span class="o">=</span> <span class="s1">&#39;sum_field&#39;</span>

    <span class="k">def</span> <span class="nf">tr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a translatable string with the self.tr() function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DissolveProcessingAlgorithm</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the algorithm name, used for identifying the algorithm. This</span>
<span class="sd">        string should be fixed for the algorithm, and must not be localised.</span>
<span class="sd">        The name should be unique within each provider. Names should contain</span>
<span class="sd">        lowercase alphanumeric characters only and no spaces or other</span>
<span class="sd">        formatting characters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;dissolve_with_sum&#39;</span>

    <span class="k">def</span> <span class="nf">displayName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the translated algorithm name, which should be used for any</span>
<span class="sd">        user-visible display of the algorithm name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;Dissolve with Sum&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the name of the group this algorithm belongs to. This string</span>
<span class="sd">        should be localised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;scripts&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">groupId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the unique ID of the group this algorithm belongs to. This</span>
<span class="sd">        string should be fixed for the algorithm, and must not be localised.</span>
<span class="sd">        The group id should be unique within each provider. Group id should</span>
<span class="sd">        contain lowercase alphanumeric characters only and no spaces or other</span>
<span class="sd">        formatting characters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;scripts&#39;</span>

    <span class="k">def</span> <span class="nf">shortHelpString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a localised short helper string for the algorithm. This string</span>
<span class="sd">        should provide a basic description about what the algorithm does and the</span>
<span class="sd">        parameters and outputs associated with it..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s2">&quot;Dissolves selected features and creates and sums values of features that were dissolved&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initAlgorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Here we define the inputs and output of the algorithm, along</span>
<span class="sd">        with some other properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We add the input vector features source. It can have any kind of</span>
        <span class="c1"># geometry.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="n">QgsProcessingParameterFeatureSource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;Input layer&#39;</span><span class="p">),</span>
                <span class="p">[</span><span class="n">QgsProcessing</span><span class="o">.</span><span class="n">TypeVectorAnyGeometry</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="n">QgsProcessingParameterField</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DISSOLVE_FIELD</span><span class="p">,</span>
                <span class="s1">&#39;Choose Dissolve Field&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="n">QgsProcessingParameterField</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SUM_FIELD</span><span class="p">,</span>
                <span class="s1">&#39;Choose Sum Field&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">))</span>
        <span class="c1"># We add a feature sink in which to store our processed features (this</span>
        <span class="c1"># usually takes the form of a newly created vector layer when the</span>
        <span class="c1"># algorithm is run in QGIS).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="n">QgsProcessingParameterFeatureSink</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;Output layer&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">processAlgorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">feedback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Here is where the processing itself takes place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsSource</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span>
            <span class="n">context</span>
        <span class="p">)</span>
        <span class="n">dissolve_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsString</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DISSOLVE_FIELD</span><span class="p">,</span>
            <span class="n">context</span><span class="p">)</span>
        <span class="n">sum_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsString</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SUM_FIELD</span><span class="p">,</span>
            <span class="n">context</span><span class="p">)</span>
        
        <span class="n">fields</span> <span class="o">=</span> <span class="n">QgsFields</span><span class="p">()</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="n">dissolve_field</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">))</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s1">&#39;SUM_&#39;</span> <span class="o">+</span> <span class="n">sum_field</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">Double</span><span class="p">))</span>
        
        <span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterAsSink</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">,</span>
            <span class="n">context</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">wkbType</span><span class="p">(),</span> <span class="n">source</span><span class="o">.</span><span class="n">sourceCrs</span><span class="p">())</span>
        
        <span class="c1"># Create a dictionary to hold the unique values from the </span>
        <span class="c1"># dissolve_field and the sum of the values from the sum_field</span>
        <span class="n">feedback</span><span class="o">.</span><span class="n">pushInfo</span><span class="p">(</span><span class="s1">&#39;Extracting unique values from dissolve_field and computing sum&#39;</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">)</span>
        <span class="c1"># Get Indices of dissolve field and sum field</span>
        <span class="n">dissolveIdx</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">fields</span><span class="p">()</span><span class="o">.</span><span class="n">indexFromName</span><span class="p">(</span><span class="n">dissolve_field</span><span class="p">)</span>
        <span class="n">sumIdx</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">fields</span><span class="p">()</span><span class="o">.</span><span class="n">indexFromName</span><span class="p">(</span><span class="n">sum_field</span><span class="p">)</span>
        
        <span class="c1"># Find all unique values for the given dissolve_field and</span>
        <span class="c1"># sum the corresponding values from the sum_field</span>
        <span class="n">sum_unique_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">dissolve_field</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="n">dissolveIdx</span><span class="p">],</span> <span class="n">sum_field</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="n">sumIdx</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">unique_value</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f_attr</span><span class="p">[</span><span class="n">sum_field</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">f_attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">f_attr</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]</span> <span class="o">==</span> <span class="n">unique_value</span><span class="p">]</span>
            <span class="n">sum_unique_values</span><span class="p">[</span><span class="n">unique_value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">val_list</span><span class="p">)</span>
        
        <span class="c1"># Running the processing dissolve algorithm</span>
        <span class="n">feedback</span><span class="o">.</span><span class="n">pushInfo</span><span class="p">(</span><span class="s1">&#39;Dissolving features&#39;</span><span class="p">)</span>
        <span class="n">dissolved_layer</span> <span class="o">=</span> <span class="n">processing</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;native:dissolve&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;INPUT&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="p">],</span>
            <span class="s1">&#39;FIELD&#39;</span><span class="p">:</span> <span class="n">dissolve_field</span><span class="p">,</span>
            <span class="s1">&#39;OUTPUT&#39;</span><span class="p">:</span> <span class="s1">&#39;memory:&#39;</span>
        <span class="p">},</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">feedback</span><span class="o">=</span><span class="n">feedback</span><span class="p">)[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span>
        
        <span class="c1"># Read the dissolved layer and create output features</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dissolved_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">():</span>
            <span class="n">new_feature</span> <span class="o">=</span>  <span class="n">QgsFeature</span><span class="p">()</span>
            <span class="c1"># Set geometry to dissolved geometry</span>
            <span class="n">new_feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
            <span class="c1"># Set attributes from sum_unique_values dictionary that we had computed</span>
            <span class="n">new_feature</span><span class="o">.</span><span class="n">setAttributes</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">],</span> <span class="n">sum_unique_values</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">dissolve_field</span><span class="p">]]])</span>
            <span class="n">sink</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">new_feature</span><span class="p">,</span> <span class="n">QgsFeatureSink</span><span class="o">.</span><span class="n">FastInsert</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">:</span> <span class="n">dest_id</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>





  <!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to give feedback or share your experience with this tutorial, please comment below. (requires GitHub account)</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/qgis-tutorials"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>


    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2023, Ujaval Gandhi.<br/>
      Actualizado por última vez en dic 17, 2024.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.2.6.<br/>
    </p>
  </div>
</footer>
<div class="container">
  <p>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US">Creative Commons Attribution 4.0 International License</a></p>
</div>

<!-- Script fpr language switching. Largely adapted from https://github.com/pcav/faunalia-website -->
<script>
    var currentPage = 'docs/3/processing_python_scripts.html'; // coming from sphinx, always without starting '/'
    var currentLang = 'en';
    $(document).ready(function(){

        var search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
        var langPlusPage = window.location.href.match(search);
        // it's possible this is a index.html page called without 'index.html', try without the currentPage
        if (langPlusPage==undefined){
            search = new RegExp('\/[a-zA-Z_]{2,8}\/$', 'gi');
            langPlusPage = window.location.href.match(search);
        }

        // it's possible this is an index.html page called without 'index.html', try removing index.html
        if (langPlusPage==undefined){
            currentPage = currentPage.replace('index.html','')
            search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
            langPlusPage = window.location.href.match(search);
        }
        // still no langPlugPage: stop, because the language swicher will misbehave 

        if (langPlusPage == undefined || langPlusPage.length != 1){
            alert('You hit an error, please report back to us.');
            return;
        }
        langPlusPage = langPlusPage[0];
        currentLang = langPlusPage.replace(currentPage, '');

        $("#languages").val(currentLang.replace(/\//g,'')); // currentLang is something like '/nl/'

        $("#languages").change(function() {
            gotoLang($(this).val());
        });

    });

    // load current page in a different language
    function gotoLang(lang){
        var currentUrl = window.location.href;
        var newUrl = currentUrl.replace(currentLang, '/'+lang+'/');
        window.location.href = newUrl;
    }
</script>

  </body>
</html>